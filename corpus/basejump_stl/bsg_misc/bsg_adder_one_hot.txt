============================================
basejump_stl/bsg_misc/bsg_adder_one_hot
============================================

// bsg_adder_one_hot
//
// adder whose inputs and outputs are all one hot signals
//
// the adder is by default a modulo adder, so it will wrap around
// if there is a carry out.
//
// if you don't want modulo, then make the output signal wide enough; i.e. set output_width_p>=2*width_p-1
//

`include "bsg_defines.sv"

module bsg_adder_one_hot #(parameter `BSG_INV_PARAM(width_p), parameter output_width_p=width_p)
   (input    [width_p-1:0] a_i
    , input  [width_p-1:0] b_i
    , output [output_width_p-1:0] o
    );

   genvar i,j;

   initial assert (output_width_p >= width_p)
     else begin $error("%m: unsupported output_width_p < width_p");
	$finish();
     end

   for (i=0; i < output_width_p; i++) // for each output wire
     begin: rof
	wire [width_p-1:0] aggregate;

	// for each input a_i
	// compute what bit is necessary to make it total to i
	// including wrap around in the modulo case
	
	for (j=0; j < width_p; j=j+1)
	  begin: rof2
	     if (i < j)
	       begin: rof3
		  if (output_width_p+i-j < width_p)
		    assign aggregate[j] = a_i[j] & b_i[output_width_p+i-j];
		  else
		    assign aggregate[j] = 1'b0;
	       end
	     else
	       if (i-j < width_p)
		 assign aggregate[j] = a_i[j] & b_i[i-j];
	       else
		 assign aggregate[j] = 1'b0;
	  end // block: rof2

	assign o[i] = | aggregate;

     end // block: rof

endmodule

`BSG_ABSTRACT_MODULE(bsg_adder_one_hot)

----

(source_file
  (one_line_comment)
  (one_line_comment)
  (one_line_comment)
  (one_line_comment)
  (one_line_comment)
  (one_line_comment)
  (one_line_comment)
  (one_line_comment)
  (one_line_comment)
  (include_compiler_directive
    (quoted_string
      (quoted_string_item)))
  (module_declaration
    (module_ansi_header
      (module_keyword)
      name: (simple_identifier)
      (parameter_port_list
        (parameter_port_declaration
          (parameter_declaration
            (list_of_param_assignments
              (param_assignment
                (text_macro_usage
                  (simple_identifier)
                  (list_of_actual_arguments
                    (actual_argument
                      (param_expression
                        (mintypmax_expression
                          (expression
                            (primary
                              (hierarchical_identifier
                                (simple_identifier)))))))))))))
        (parameter_port_declaration
          (parameter_declaration
            (list_of_param_assignments
              (param_assignment
                (simple_identifier)
                (constant_param_expression
                  (constant_mintypmax_expression
                    (constant_expression
                      (constant_primary
                        (simple_identifier))))))))))
      (list_of_port_declarations
        (ansi_port_declaration
          (net_port_header
            (port_direction)
            (net_port_type
              (data_type_or_implicit
                (implicit_data_type
                  (packed_dimension
                    (constant_range
                      (constant_expression
                        left: (constant_expression
                          (constant_primary
                            (simple_identifier)))
                        right: (constant_expression
                          (constant_primary
                            (primary_literal
                              (integral_number
                                (decimal_number
                                  (unsigned_number)))))))
                      (constant_expression
                        (constant_primary
                          (primary_literal
                            (integral_number
                              (decimal_number
                                (unsigned_number))))))))))))
          port_name: (simple_identifier))
        (ansi_port_declaration
          (net_port_header
            (port_direction)
            (net_port_type
              (data_type_or_implicit
                (implicit_data_type
                  (packed_dimension
                    (constant_range
                      (constant_expression
                        left: (constant_expression
                          (constant_primary
                            (simple_identifier)))
                        right: (constant_expression
                          (constant_primary
                            (primary_literal
                              (integral_number
                                (decimal_number
                                  (unsigned_number)))))))
                      (constant_expression
                        (constant_primary
                          (primary_literal
                            (integral_number
                              (decimal_number
                                (unsigned_number))))))))))))
          port_name: (simple_identifier))
        (ansi_port_declaration
          (net_port_header
            (port_direction)
            (net_port_type
              (data_type_or_implicit
                (implicit_data_type
                  (packed_dimension
                    (constant_range
                      (constant_expression
                        left: (constant_expression
                          (constant_primary
                            (simple_identifier)))
                        right: (constant_expression
                          (constant_primary
                            (primary_literal
                              (integral_number
                                (decimal_number
                                  (unsigned_number)))))))
                      (constant_expression
                        (constant_primary
                          (primary_literal
                            (integral_number
                              (decimal_number
                                (unsigned_number))))))))))))
          port_name: (simple_identifier))))
    (genvar_declaration
      (list_of_genvar_identifiers
        (simple_identifier)
        (simple_identifier)))
    (initial_construct
      (statement_or_null
        (statement
          (statement_item
            (simple_immediate_assert_statement
              (expression
                left: (expression
                  (primary
                    (hierarchical_identifier
                      (simple_identifier))))
                right: (expression
                  (primary
                    (hierarchical_identifier
                      (simple_identifier)))))
              (action_block
                (statement_or_null
                  (statement
                    (statement_item
                      (seq_block
                        (statement_or_null
                          (statement
                            (statement_item
                              (subroutine_call_statement
                                (severity_system_task
                                  (list_of_arguments
                                    (expression
                                      (primary
                                        (primary_literal
                                          (string_literal
                                            (quoted_string
                                              (quoted_string_item))))))))))))
                        (statement_or_null
                          (statement
                            (statement_item
                              (subroutine_call_statement
                                (simulation_control_task)))))))))))))))
    (loop_generate_construct
      (genvar_initialization
        (simple_identifier)
        (constant_expression
          (constant_primary
            (primary_literal
              (integral_number
                (decimal_number
                  (unsigned_number)))))))
      (constant_expression
        left: (constant_expression
          (constant_primary
            (simple_identifier)))
        right: (constant_expression
          (constant_primary
            (simple_identifier))))
      (genvar_iteration
        (simple_identifier)
        (inc_or_dec_operator))
      (one_line_comment)
      (generate_block
        name: (simple_identifier)
        (net_declaration
          (net_type)
          (data_type_or_implicit
            (implicit_data_type
              (packed_dimension
                (constant_range
                  (constant_expression
                    left: (constant_expression
                      (constant_primary
                        (simple_identifier)))
                    right: (constant_expression
                      (constant_primary
                        (primary_literal
                          (integral_number
                            (decimal_number
                              (unsigned_number)))))))
                  (constant_expression
                    (constant_primary
                      (primary_literal
                        (integral_number
                          (decimal_number
                            (unsigned_number))))))))))
          (list_of_net_decl_assignments
            (net_decl_assignment
              (simple_identifier))))
        (one_line_comment)
        (one_line_comment)
        (one_line_comment)
        (loop_generate_construct
          (genvar_initialization
            (simple_identifier)
            (constant_expression
              (constant_primary
                (primary_literal
                  (integral_number
                    (decimal_number
                      (unsigned_number)))))))
          (constant_expression
            left: (constant_expression
              (constant_primary
                (simple_identifier)))
            right: (constant_expression
              (constant_primary
                (simple_identifier))))
          (genvar_iteration
            (simple_identifier)
            (assignment_operator)
            (constant_expression
              left: (constant_expression
                (constant_primary
                  (simple_identifier)))
              right: (constant_expression
                (constant_primary
                  (primary_literal
                    (integral_number
                      (decimal_number
                        (unsigned_number))))))))
          (generate_block
            name: (simple_identifier)
            (conditional_generate_construct
              (if_generate_construct
                (constant_expression
                  left: (constant_expression
                    (constant_primary
                      (simple_identifier)))
                  right: (constant_expression
                    (constant_primary
                      (simple_identifier))))
                (generate_block
                  name: (simple_identifier)
                  (conditional_generate_construct
                    (if_generate_construct
                      (constant_expression
                        left: (constant_expression
                          left: (constant_expression
                            left: (constant_expression
                              (constant_primary
                                (simple_identifier)))
                            right: (constant_expression
                              (constant_primary
                                (simple_identifier))))
                          right: (constant_expression
                            (constant_primary
                              (simple_identifier))))
                        right: (constant_expression
                          (constant_primary
                            (simple_identifier))))
                      (generate_block
                        (continuous_assign
                          (list_of_net_assignments
                            (net_assignment
                              (net_lvalue
                                (simple_identifier)
                                (constant_select
                                  (constant_bit_select
                                    (constant_expression
                                      (constant_primary
                                        (simple_identifier))))))
                              (expression
                                left: (expression
                                  (primary
                                    (hierarchical_identifier
                                      (simple_identifier))
                                    (select
                                      (bit_select
                                        (expression
                                          (primary
                                            (hierarchical_identifier
                                              (simple_identifier))))))))
                                right: (expression
                                  (primary
                                    (hierarchical_identifier
                                      (simple_identifier))
                                    (select
                                      (bit_select
                                        (expression
                                          left: (expression
                                            left: (expression
                                              (primary
                                                (hierarchical_identifier
                                                  (simple_identifier))))
                                            right: (expression
                                              (primary
                                                (hierarchical_identifier
                                                  (simple_identifier)))))
                                          right: (expression
                                            (primary
                                              (hierarchical_identifier
                                                (simple_identifier))))))))))))))
                      (generate_block
                        (continuous_assign
                          (list_of_net_assignments
                            (net_assignment
                              (net_lvalue
                                (simple_identifier)
                                (constant_select
                                  (constant_bit_select
                                    (constant_expression
                                      (constant_primary
                                        (simple_identifier))))))
                              (expression
                                (primary
                                  (primary_literal
                                    (integral_number
                                      (binary_number
                                        size: (unsigned_number)
                                        base: (binary_base)
                                        value: (binary_value)))))))))))))
                (generate_block
                  (conditional_generate_construct
                    (if_generate_construct
                      (constant_expression
                        left: (constant_expression
                          left: (constant_expression
                            (constant_primary
                              (simple_identifier)))
                          right: (constant_expression
                            (constant_primary
                              (simple_identifier))))
                        right: (constant_expression
                          (constant_primary
                            (simple_identifier))))
                      (generate_block
                        (continuous_assign
                          (list_of_net_assignments
                            (net_assignment
                              (net_lvalue
                                (simple_identifier)
                                (constant_select
                                  (constant_bit_select
                                    (constant_expression
                                      (constant_primary
                                        (simple_identifier))))))
                              (expression
                                left: (expression
                                  (primary
                                    (hierarchical_identifier
                                      (simple_identifier))
                                    (select
                                      (bit_select
                                        (expression
                                          (primary
                                            (hierarchical_identifier
                                              (simple_identifier))))))))
                                right: (expression
                                  (primary
                                    (hierarchical_identifier
                                      (simple_identifier))
                                    (select
                                      (bit_select
                                        (expression
                                          left: (expression
                                            (primary
                                              (hierarchical_identifier
                                                (simple_identifier))))
                                          right: (expression
                                            (primary
                                              (hierarchical_identifier
                                                (simple_identifier))))))))))))))
                      (generate_block
                        (continuous_assign
                          (list_of_net_assignments
                            (net_assignment
                              (net_lvalue
                                (simple_identifier)
                                (constant_select
                                  (constant_bit_select
                                    (constant_expression
                                      (constant_primary
                                        (simple_identifier))))))
                              (expression
                                (primary
                                  (primary_literal
                                    (integral_number
                                      (binary_number
                                        size: (unsigned_number)
                                        base: (binary_base)
                                        value: (binary_value)))))))))))))))))
        (one_line_comment)
        (continuous_assign
          (list_of_net_assignments
            (net_assignment
              (net_lvalue
                (simple_identifier)
                (constant_select
                  (constant_bit_select
                    (constant_expression
                      (constant_primary
                        (simple_identifier))))))
              (expression
                operator: (unary_operator)
                argument: (primary
                  (hierarchical_identifier
                    (simple_identifier)))))))))
    (one_line_comment))
  (text_macro_usage
    (simple_identifier)
    (list_of_actual_arguments
      (actual_argument
        (param_expression
          (mintypmax_expression
            (expression
              (primary
                (hierarchical_identifier
                  (simple_identifier))))))))))
