============================================
basejump_stl/bsg_test/bsg_nonsynth_dpi_cycle_counter
============================================

// This modules defines a DPI interface for a counter that can be read
// periodically using DPI
`include "bsg_defines.sv"

module bsg_nonsynth_dpi_cycle_counter
  #(
     parameter int width_p = 1
    ,parameter bit debug_p = 0
    )
   (
    input clk_i
    ,input reset_i

    ,output logic [width_p-1:0] ctr_r_o
    ,output logic debug_o
    );

   export "DPI-C" function bsg_dpi_init;
   export "DPI-C" function bsg_dpi_fini;
   export "DPI-C" function bsg_dpi_debug;
   export "DPI-C" function bsg_dpi_width;
   export "DPI-C" function bsg_dpi_cycle_counter_read;
   export "DPI-C" function bsg_dpi_cycle_counter_is_window;

   // Tracks whether init has been called
   logic  init_l;

   // Print module parameters to the console and set the intial debug
   // value.   
   initial begin
      $display("BSG INFO: bsg_nonsynth_dpi_cycle_counter (initial begin)");
      $display("BSG INFO:     Instantiation: %M");
      $display("BSG INFO:     width_p = %d", width_p);
      $display("BSG INFO:     debug_p = %d", debug_p);
   end

   bsg_cycle_counter
     #(.width_p(width_p)
       ,.init_val_p('0))
   counter_inst
     (.clk_i(clk_i)
      ,.reset_i(reset_i)
      ,.ctr_r_o(ctr_r_o));

   // We track the polarity of the current edge so that we can notify
   // the user of incorrect behavior.
   logic    edgepol;
   always_ff @(posedge clk_i or negedge clk_i) begin
      edgepol <= clk_i;
   end

   // Initialize this Module
   function void bsg_dpi_init();
      if(init_l)
        $fatal(1, "BSG ERROR (%M): init() already called");

      init_l = 1;
   endfunction

   // Terminate this Module
   function void bsg_dpi_fini();
      if(~init_l)
        $fatal(1, "BSG ERROR (%M): fini() already called");

      init_l = 0;
   endfunction

   // Set or unset the debug_o output bit. If a state change occurs
   // (0->1 or 1->0) then module will print DEBUG ENABLED / DEBUG
   // DISABLED. No messages are printed if a state change does not
   // occur.
   function void bsg_dpi_debug(input bit switch_i);
      if(!debug_o & switch_i)
        $display("BSG DBGINFO (%M@%t): DEBUG ENABLED", $time);
      else if (debug_o & !switch_i) 
        $display("BSG DBGINFO (%M@%t): DEBUG DISABLED", $time);

      debug_o = switch_i;
   endfunction

   // Returns width_p
   function int bsg_dpi_width();
      return width_p;
   endfunction

   // The function bsg_dpi returns true if the interface is in a
   // valid time-window to call bsg_dpi_fifo_rx()
   function bit bsg_dpi_cycle_counter_is_window();
      return (clk_i & edgepol & ~reset_i);
   endfunction

   // Read and return the current counter value.
   function void bsg_dpi_cycle_counter_read(output bit [width_p-1:0] data_bo);
      if(init_l === 0) begin
         $fatal(1,"BSG ERROR (%M): read() called before init()");
      end

      if(reset_i === 1) begin
         $fatal(1, "BSG ERROR (%M): read() called while reset_i === 1");
      end      

      if(clk_i === 0) begin
         $fatal(1, "BSG ERROR (%M): read() must be called when clk_i == 1");
      end

      if(edgepol === 0) begin
        $fatal(1, "BSG ERROR (%M): read() must be called after the positive edge of clk_i has been evaluated");
      end

      data_bo = ctr_r_o;
   endfunction

endmodule


----

(source_file
  (one_line_comment)
  (one_line_comment)
  (include_compiler_directive
    (quoted_string
      (quoted_string_item)))
  (module_declaration
    (module_ansi_header
      (module_keyword)
      name: (simple_identifier)
      (parameter_port_list
        (parameter_port_declaration
          (parameter_declaration
            (data_type_or_implicit
              (data_type
                (integer_atom_type)))
            (list_of_param_assignments
              (param_assignment
                (simple_identifier)
                (constant_param_expression
                  (constant_mintypmax_expression
                    (constant_expression
                      (constant_primary
                        (primary_literal
                          (integral_number
                            (decimal_number
                              (unsigned_number))))))))))))
        (parameter_port_declaration
          (parameter_declaration
            (data_type_or_implicit
              (data_type
                (integer_vector_type)))
            (list_of_param_assignments
              (param_assignment
                (simple_identifier)
                (constant_param_expression
                  (constant_mintypmax_expression
                    (constant_expression
                      (constant_primary
                        (primary_literal
                          (integral_number
                            (decimal_number
                              (unsigned_number)))))))))))))
      (list_of_port_declarations
        (ansi_port_declaration
          (net_port_header
            (port_direction))
          port_name: (simple_identifier))
        (ansi_port_declaration
          (net_port_header
            (port_direction))
          port_name: (simple_identifier))
        (ansi_port_declaration
          (variable_port_header
            (port_direction)
            (variable_port_type
              (data_type
                (integer_vector_type)
                (packed_dimension
                  (constant_range
                    (constant_expression
                      left: (constant_expression
                        (constant_primary
                          (simple_identifier)))
                      right: (constant_expression
                        (constant_primary
                          (primary_literal
                            (integral_number
                              (decimal_number
                                (unsigned_number)))))))
                    (constant_expression
                      (constant_primary
                        (primary_literal
                          (integral_number
                            (decimal_number
                              (unsigned_number)))))))))))
          port_name: (simple_identifier))
        (ansi_port_declaration
          (variable_port_header
            (port_direction)
            (variable_port_type
              (data_type
                (integer_vector_type))))
          port_name: (simple_identifier))))
    (dpi_import_export
      (dpi_spec_string)
      name: (simple_identifier))
    (dpi_import_export
      (dpi_spec_string)
      name: (simple_identifier))
    (dpi_import_export
      (dpi_spec_string)
      name: (simple_identifier))
    (dpi_import_export
      (dpi_spec_string)
      name: (simple_identifier))
    (dpi_import_export
      (dpi_spec_string)
      name: (simple_identifier))
    (dpi_import_export
      (dpi_spec_string)
      name: (simple_identifier))
    (one_line_comment)
    (data_declaration
      (data_type_or_implicit
        (data_type
          (integer_vector_type)))
      (list_of_variable_decl_assignments
        (variable_decl_assignment
          name: (simple_identifier))))
    (one_line_comment)
    (one_line_comment)
    (initial_construct
      (statement_or_null
        (statement
          (statement_item
            (seq_block
              (statement_or_null
                (statement
                  (statement_item
                    (subroutine_call_statement
                      (subroutine_call
                        (system_tf_call
                          (system_tf_identifier)
                          (list_of_arguments
                            (expression
                              (primary
                                (primary_literal
                                  (string_literal
                                    (quoted_string
                                      (quoted_string_item)))))))))))))
              (statement_or_null
                (statement
                  (statement_item
                    (subroutine_call_statement
                      (subroutine_call
                        (system_tf_call
                          (system_tf_identifier)
                          (list_of_arguments
                            (expression
                              (primary
                                (primary_literal
                                  (string_literal
                                    (quoted_string
                                      (quoted_string_item)))))))))))))
              (statement_or_null
                (statement
                  (statement_item
                    (subroutine_call_statement
                      (subroutine_call
                        (system_tf_call
                          (system_tf_identifier)
                          (list_of_arguments
                            (expression
                              (primary
                                (primary_literal
                                  (string_literal
                                    (quoted_string
                                      (quoted_string_item))))))
                            (expression
                              (primary
                                (hierarchical_identifier
                                  (simple_identifier)))))))))))
              (statement_or_null
                (statement
                  (statement_item
                    (subroutine_call_statement
                      (subroutine_call
                        (system_tf_call
                          (system_tf_identifier)
                          (list_of_arguments
                            (expression
                              (primary
                                (primary_literal
                                  (string_literal
                                    (quoted_string
                                      (quoted_string_item))))))
                            (expression
                              (primary
                                (hierarchical_identifier
                                  (simple_identifier))))))))))))))))
    (module_instantiation
      instance_type: (simple_identifier)
      (parameter_value_assignment
        (list_of_parameter_value_assignments
          (named_parameter_assignment
            (simple_identifier)
            (param_expression
              (mintypmax_expression
                (expression
                  (primary
                    (hierarchical_identifier
                      (simple_identifier)))))))
          (named_parameter_assignment
            (simple_identifier)
            (param_expression
              (mintypmax_expression
                (expression
                  (primary
                    (primary_literal
                      (unbased_unsized_literal)))))))))
      (hierarchical_instance
        (name_of_instance
          instance_name: (simple_identifier))
        (list_of_port_connections
          (named_port_connection
            port_name: (simple_identifier)
            connection: (expression
              (primary
                (hierarchical_identifier
                  (simple_identifier)))))
          (named_port_connection
            port_name: (simple_identifier)
            connection: (expression
              (primary
                (hierarchical_identifier
                  (simple_identifier)))))
          (named_port_connection
            port_name: (simple_identifier)
            connection: (expression
              (primary
                (hierarchical_identifier
                  (simple_identifier))))))))
    (one_line_comment)
    (one_line_comment)
    (data_declaration
      (data_type_or_implicit
        (data_type
          (integer_vector_type)))
      (list_of_variable_decl_assignments
        (variable_decl_assignment
          name: (simple_identifier))))
    (always_construct
      (always_keyword)
      (statement
        (statement_item
          (procedural_timing_control_statement
            (event_control
              (clocking_event
                (event_expression
                  (event_expression
                    (edge_identifier)
                    (expression
                      (primary
                        (hierarchical_identifier
                          (simple_identifier)))))
                  (event_expression
                    (edge_identifier)
                    (expression
                      (primary
                        (hierarchical_identifier
                          (simple_identifier))))))))
            (statement_or_null
              (statement
                (statement_item
                  (seq_block
                    (statement_or_null
                      (statement
                        (statement_item
                          (nonblocking_assignment
                            (variable_lvalue
                              (hierarchical_identifier
                                (simple_identifier)))
                            (expression
                              (primary
                                (hierarchical_identifier
                                  (simple_identifier))))))))))))))))
    (one_line_comment)
    (function_declaration
      (function_body_declaration
        (data_type_or_void)
        name: (simple_identifier)
        (function_statement_or_null
          (function_statement
            (statement
              (statement_item
                (conditional_statement
                  (cond_predicate
                    (expression
                      (primary
                        (hierarchical_identifier
                          (simple_identifier)))))
                  (statement_or_null
                    (statement
                      (statement_item
                        (subroutine_call_statement
                          (severity_system_task
                            (finish_number)
                            (list_of_arguments
                              (expression
                                (primary
                                  (primary_literal
                                    (string_literal
                                      (quoted_string
                                        (quoted_string_item)))))))))))))))))
        (function_statement_or_null
          (function_statement
            (statement
              (statement_item
                (blocking_assignment
                  (operator_assignment
                    (variable_lvalue
                      (hierarchical_identifier
                        (simple_identifier)))
                    (assignment_operator)
                    (expression
                      (primary
                        (primary_literal
                          (integral_number
                            (decimal_number
                              (unsigned_number))))))))))))))
    (one_line_comment)
    (function_declaration
      (function_body_declaration
        (data_type_or_void)
        name: (simple_identifier)
        (function_statement_or_null
          (function_statement
            (statement
              (statement_item
                (conditional_statement
                  (cond_predicate
                    (expression
                      operator: (unary_operator)
                      argument: (primary
                        (hierarchical_identifier
                          (simple_identifier)))))
                  (statement_or_null
                    (statement
                      (statement_item
                        (subroutine_call_statement
                          (severity_system_task
                            (finish_number)
                            (list_of_arguments
                              (expression
                                (primary
                                  (primary_literal
                                    (string_literal
                                      (quoted_string
                                        (quoted_string_item)))))))))))))))))
        (function_statement_or_null
          (function_statement
            (statement
              (statement_item
                (blocking_assignment
                  (operator_assignment
                    (variable_lvalue
                      (hierarchical_identifier
                        (simple_identifier)))
                    (assignment_operator)
                    (expression
                      (primary
                        (primary_literal
                          (integral_number
                            (decimal_number
                              (unsigned_number))))))))))))))
    (one_line_comment)
    (one_line_comment)
    (one_line_comment)
    (one_line_comment)
    (function_declaration
      (function_body_declaration
        (data_type_or_void)
        name: (simple_identifier)
        (tf_port_list
          (tf_port_item
            (tf_port_direction
              (port_direction))
            (data_type_or_implicit
              (data_type
                (integer_vector_type)))
            name: (simple_identifier)))
        (function_statement_or_null
          (function_statement
            (statement
              (statement_item
                (conditional_statement
                  (cond_predicate
                    (expression
                      left: (expression
                        operator: (unary_operator)
                        argument: (primary
                          (hierarchical_identifier
                            (simple_identifier))))
                      right: (expression
                        (primary
                          (hierarchical_identifier
                            (simple_identifier))))))
                  (statement_or_null
                    (statement
                      (statement_item
                        (subroutine_call_statement
                          (subroutine_call
                            (system_tf_call
                              (system_tf_identifier)
                              (list_of_arguments
                                (expression
                                  (primary
                                    (primary_literal
                                      (string_literal
                                        (quoted_string
                                          (quoted_string_item))))))
                                (expression
                                  (primary
                                    (function_subroutine_call
                                      (subroutine_call
                                        (system_tf_call
                                          (system_tf_identifier)))))))))))))
                  (cond_predicate
                    (expression
                      left: (expression
                        (primary
                          (hierarchical_identifier
                            (simple_identifier))))
                      right: (expression
                        operator: (unary_operator)
                        argument: (primary
                          (hierarchical_identifier
                            (simple_identifier))))))
                  (statement_or_null
                    (statement
                      (statement_item
                        (subroutine_call_statement
                          (subroutine_call
                            (system_tf_call
                              (system_tf_identifier)
                              (list_of_arguments
                                (expression
                                  (primary
                                    (primary_literal
                                      (string_literal
                                        (quoted_string
                                          (quoted_string_item))))))
                                (expression
                                  (primary
                                    (function_subroutine_call
                                      (subroutine_call
                                        (system_tf_call
                                          (system_tf_identifier))))))))))))))))))
        (function_statement_or_null
          (function_statement
            (statement
              (statement_item
                (blocking_assignment
                  (operator_assignment
                    (variable_lvalue
                      (hierarchical_identifier
                        (simple_identifier)))
                    (assignment_operator)
                    (expression
                      (primary
                        (hierarchical_identifier
                          (simple_identifier))))))))))))
    (one_line_comment)
    (function_declaration
      (function_body_declaration
        (data_type_or_void
          (data_type
            (integer_atom_type)))
        name: (simple_identifier)
        (function_statement_or_null
          (function_statement
            (statement
              (statement_item
                (jump_statement
                  (expression
                    (primary
                      (hierarchical_identifier
                        (simple_identifier)))))))))))
    (one_line_comment)
    (one_line_comment)
    (function_declaration
      (function_body_declaration
        (data_type_or_void
          (data_type
            (integer_vector_type)))
        name: (simple_identifier)
        (function_statement_or_null
          (function_statement
            (statement
              (statement_item
                (jump_statement
                  (expression
                    (primary
                      (mintypmax_expression
                        (expression
                          left: (expression
                            left: (expression
                              (primary
                                (hierarchical_identifier
                                  (simple_identifier))))
                            right: (expression
                              (primary
                                (hierarchical_identifier
                                  (simple_identifier)))))
                          right: (expression
                            operator: (unary_operator)
                            argument: (primary
                              (hierarchical_identifier
                                (simple_identifier)))))))))))))))
    (one_line_comment)
    (function_declaration
      (function_body_declaration
        (data_type_or_void)
        name: (simple_identifier)
        (tf_port_list
          (tf_port_item
            (tf_port_direction
              (port_direction))
            (data_type_or_implicit
              (data_type
                (integer_vector_type)
                (packed_dimension
                  (constant_range
                    (constant_expression
                      left: (constant_expression
                        (constant_primary
                          (simple_identifier)))
                      right: (constant_expression
                        (constant_primary
                          (primary_literal
                            (integral_number
                              (decimal_number
                                (unsigned_number)))))))
                    (constant_expression
                      (constant_primary
                        (primary_literal
                          (integral_number
                            (decimal_number
                              (unsigned_number))))))))))
            name: (simple_identifier)))
        (function_statement_or_null
          (function_statement
            (statement
              (statement_item
                (conditional_statement
                  (cond_predicate
                    (expression
                      left: (expression
                        (primary
                          (hierarchical_identifier
                            (simple_identifier))))
                      right: (expression
                        (primary
                          (primary_literal
                            (integral_number
                              (decimal_number
                                (unsigned_number))))))))
                  (statement_or_null
                    (statement
                      (statement_item
                        (seq_block
                          (statement_or_null
                            (statement
                              (statement_item
                                (subroutine_call_statement
                                  (severity_system_task
                                    (finish_number)
                                    (list_of_arguments
                                      (expression
                                        (primary
                                          (primary_literal
                                            (string_literal
                                              (quoted_string
                                                (quoted_string_item)))))))))))))))))))))
        (function_statement_or_null
          (function_statement
            (statement
              (statement_item
                (conditional_statement
                  (cond_predicate
                    (expression
                      left: (expression
                        (primary
                          (hierarchical_identifier
                            (simple_identifier))))
                      right: (expression
                        (primary
                          (primary_literal
                            (integral_number
                              (decimal_number
                                (unsigned_number))))))))
                  (statement_or_null
                    (statement
                      (statement_item
                        (seq_block
                          (statement_or_null
                            (statement
                              (statement_item
                                (subroutine_call_statement
                                  (severity_system_task
                                    (finish_number)
                                    (list_of_arguments
                                      (expression
                                        (primary
                                          (primary_literal
                                            (string_literal
                                              (quoted_string
                                                (quoted_string_item)))))))))))))))))))))
        (function_statement_or_null
          (function_statement
            (statement
              (statement_item
                (conditional_statement
                  (cond_predicate
                    (expression
                      left: (expression
                        (primary
                          (hierarchical_identifier
                            (simple_identifier))))
                      right: (expression
                        (primary
                          (primary_literal
                            (integral_number
                              (decimal_number
                                (unsigned_number))))))))
                  (statement_or_null
                    (statement
                      (statement_item
                        (seq_block
                          (statement_or_null
                            (statement
                              (statement_item
                                (subroutine_call_statement
                                  (severity_system_task
                                    (finish_number)
                                    (list_of_arguments
                                      (expression
                                        (primary
                                          (primary_literal
                                            (string_literal
                                              (quoted_string
                                                (quoted_string_item)))))))))))))))))))))
        (function_statement_or_null
          (function_statement
            (statement
              (statement_item
                (conditional_statement
                  (cond_predicate
                    (expression
                      left: (expression
                        (primary
                          (hierarchical_identifier
                            (simple_identifier))))
                      right: (expression
                        (primary
                          (primary_literal
                            (integral_number
                              (decimal_number
                                (unsigned_number))))))))
                  (statement_or_null
                    (statement
                      (statement_item
                        (seq_block
                          (statement_or_null
                            (statement
                              (statement_item
                                (subroutine_call_statement
                                  (severity_system_task
                                    (finish_number)
                                    (list_of_arguments
                                      (expression
                                        (primary
                                          (primary_literal
                                            (string_literal
                                              (quoted_string
                                                (quoted_string_item)))))))))))))))))))))
        (function_statement_or_null
          (function_statement
            (statement
              (statement_item
                (blocking_assignment
                  (operator_assignment
                    (variable_lvalue
                      (hierarchical_identifier
                        (simple_identifier)))
                    (assignment_operator)
                    (expression
                      (primary
                        (hierarchical_identifier
                          (simple_identifier))))))))))))))
